<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interaktiver Model-Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #374151;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            background-color: #ffffff;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            max-width: 900px;
            width: 95%;
            margin: 2rem;
        }
        .grid-container {
            display: grid;
            gap: 1.5rem;
            grid-template-columns: repeat(1, 1fr);
        }
        @media (min-width: 768px) {
            .grid-container {
                grid-template-columns: 1fr 1fr;
            }
        }
        .image-upload-area {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .image-placeholder {
            width: 100%;
            height: 150px;
            background-color: #f9fafb;
            border: 2px dashed #e5e7eb;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            color: #9ca3af;
            border-radius: 0.75rem;
            overflow: hidden;
            position: relative;
        }
        .image-placeholder img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        .button {
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: 600;
            transition: all 0.2s;
            cursor: pointer;
        }
        .button-primary {
            background-color: #3b82f6;
            color: #ffffff;
        }
        .button-primary:hover {
            background-color: #2563eb;
        }
        .button-secondary {
            background-color: #e5e7eb;
            color: #4b5563;
        }
        .button-secondary:hover {
            background-color: #d1d5db;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .image-viewer {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 400px;
            border-radius: 1.5rem;
            background-color: #e5e7eb;
            overflow: hidden;
        }
        .image-viewer img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        .error-message {
            background-color: #fee2e2;
            color: #991b1b;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-top: 1rem;
            display: none;
        }
        .rotation-buttons {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            margin-top: 1rem;
        }
        .rotation-button {
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            background-color: #4b5563;
            color: #ffffff;
            font-size: 1.5rem;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
            flex-grow: 1;
        }
        .rotation-button:hover {
            background-color: #374151;
        }
    </style>
</head>
<body>

<div class="container">
    <h1 class="text-3xl font-bold text-center mb-6">Model-Foto Generator</h1>
    <p class="text-center text-gray-500 mb-8">
        Erzeugen Sie professionelle Model-Fotos mit KI. Beschreiben Sie Ihre Vision und laden Sie optional bis zu 3 Referenzbilder hoch, die als Inspiration dienen.
    </p>

    <div class="grid-container">
        <!-- Eingabebereich -->
        <div class="flex flex-col gap-4">
            <!-- Text-Prompt -->
            <div>
                <label for="prompt" class="block text-sm font-semibold mb-2">Prompt (Textbeschreibung)</label>
                <textarea id="prompt" rows="8" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow">
### Typ
- Model, Frau, ca. 25 Jahre alt, schlank, sportlich, gesundes Erscheinungsbild
- Blondes Haar, leicht gewellt, weicher Scheitel, Schulterlänge
- Makellose Haut, leichte Sommersprossen, dezentes, natürliches Make-up

### Pose & Ausdruck
- Steht frontal, aufrecht, Schultern leicht zurück
- Leichter, freundlicher Gesichtsausdruck, dezentes Lächeln
- Schaut direkt in die Kamera, selbstbewusst und freundlich
- Hände locker an den Seiten, entspannte Haltung

### Kleidung
- Einfaches, enganliegendes, weißes T-Shirt
- Helle, zerrissene Jeans, gute Passform
- Dezente, weiße Sneaker

### Hintergrund
- Reinweiß, makellos
- Sehr weicher, fast unsichtbarer Schatten, der eine leichte Tiefe erzeugt

### Stil & Qualität
- Ultrarealistisch, detailgetreue Wiedergabe von Haut, Haaren und Stoff
- Professionelles Studiolicht, gleichmäßige Beleuchtung
- Perfektionierte, hochdetaillierte Details, gestochen scharfe Qualität
- 8K Auflösung, fotografischer Stil
                </textarea>
            </div>

            <!-- Bild-Uploads -->
            <div class="image-upload-area">
                <label class="block text-sm font-semibold mb-1">Referenzbilder (optional, bis zu 3)</label>
                <input type="file" id="imageUpload1" accept="image/*" class="hidden" />
                <div class="image-placeholder cursor-pointer" id="placeholder1">
                    <span class="text-center">Bild 1<br>(optional)</span>
                    <img id="preview1" class="hidden" />
                </div>
                <input type="file" id="imageUpload2" accept="image/*" class="hidden" />
                <div class="image-placeholder cursor-pointer" id="placeholder2">
                    <span class="text-center">Bild 2<br>(optional)</span>
                    <img id="preview2" class="hidden" />
                </div>
                <input type="file" id="imageUpload3" accept="image/*" class="hidden" />
                <div class="image-placeholder cursor-pointer" id="placeholder3">
                    <span class="text-center">Bild 3<br>(optional)</span>
                    <img id="preview3" class="hidden" />
                </div>
            </div>

            <!-- Button zur Generierung -->
            <button id="generateBtn" class="button button-primary flex items-center justify-center mt-2">
                Foto generieren
            </button>
        </div>

        <!-- Ausgabebereich -->
        <div class="flex flex-col">
            <div class="image-viewer" id="imageViewer">
                <span id="initialText" class="text-gray-400">Das generierte Bild wird hier angezeigt.</span>
                <div id="loadingIndicator" class="hidden">
                    <div class="spinner"></div>
                </div>
                <img id="generatedImage" class="hidden" alt="Generiertes Model-Foto" />
            </div>

            <div class="rotation-buttons hidden" id="rotationButtons">
                <button id="rotateLeftBtn" class="rotation-button" title="Um 15° nach links drehen">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <button id="rotateRightBtn" class="rotation-button" title="Um 15° nach rechts drehen">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                </button>
            </div>
            
            <div id="messageBox" class="error-message"></div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // DOM-Elemente abrufen
    const promptInput = document.getElementById('prompt');
    const imageUploads = [document.getElementById('imageUpload1'), document.getElementById('imageUpload2'), document.getElementById('imageUpload3')];
    const placeholders = [document.getElementById('placeholder1'), document.getElementById('placeholder2'), document.getElementById('placeholder3')];
    const imagePreviews = [document.getElementById('preview1'), document.getElementById('preview2'), document.getElementById('preview3')];
    const generateBtn = document.getElementById('generateBtn');
    const rotateLeftBtn = document.getElementById('rotateLeftBtn');
    const rotateRightBtn = document.getElementById('rotateRightBtn');
    const imageViewer = document.getElementById('imageViewer');
    const initialText = document.getElementById('initialText');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const generatedImage = document.getElementById('generatedImage');
    const rotationButtons = document.getElementById('rotationButtons');
    const messageBox = document.getElementById('messageBox');

    let currentRotationAngle = 0;
    const rotationIncrement = 15;
    const rotationLimit = 45;

    // Event Listener für Bild-Uploads und Vorschau
    placeholders.forEach((placeholder, index) => {
        placeholder.addEventListener('click', () => {
            imageUploads[index].click();
        });

        imageUploads[index].addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    imagePreviews[index].src = event.target.result;
                    imagePreviews[index].classList.remove('hidden');
                    placeholder.querySelector('span').classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        });
    });

    // Funktion zur Anzeige einer Nachricht (ersetzt alert())
    function showMessage(message, isError = true) {
        messageBox.textContent = message;
        messageBox.style.display = 'block';
        if (isError) {
            messageBox.style.backgroundColor = '#fee2e2';
            messageBox.style.color = '#991b1b';
        } else {
            messageBox.style.backgroundColor = '#d1fae5';
            messageBox.style.color = '#065f46';
        }
    }

    // Bildkomprimierung mit Canvas
    function compressImage(base64, callback) {
        const img = new Image();
        img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            let width = img.width;
            let height = img.height;
            const maxSize = 1024; // Maximale Größe für die längste Seite

            if (width > height) {
                if (width > maxSize) {
                    height *= maxSize / width;
                    width = maxSize;
                }
            } else {
                if (height > maxSize) {
                    width *= maxSize / height;
                    height = maxSize;
                }
            }
            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(img, 0, 0, width, height);

            canvas.toBlob((blob) => {
                const reader = new FileReader();
                reader.onloadend = () => callback(reader.result);
                reader.readAsDataURL(blob);
            }, 'image/jpeg', 0.8); // 80% Kompressionsqualität
        };
        img.src = base64;
    }

    // Funktion zur Generierung des Bildes
    async function generateImage(rotation) {
        if (generateBtn.disabled) return;
        
        // Statusänderung der UI
        generateBtn.disabled = true;
        generateBtn.innerHTML = '<div class="spinner"></div> Generieren...';
        imageViewer.classList.add('bg-gray-200');
        initialText.classList.add('hidden');
        generatedImage.classList.add('hidden');
        loadingIndicator.classList.remove('hidden');
        messageBox.style.display = 'none';
        rotationButtons.classList.add('hidden');

        try {
            const promptText = promptInput.value.trim();
            const uploadedImages = [];
            
            for (let i = 0; i < imageUploads.length; i++) {
                if (imageUploads[i].files.length > 0) {
                    const base64 = imagePreviews[i].src;
                    const compressedBase64 = await new Promise(resolve => compressImage(base64, resolve));
                    uploadedImages.push({
                        inlineData: {
                            data: compressedBase64.split(',')[1],
                            mimeType: 'image/jpeg'
                        }
                    });
                }
            }

            const response = await fetch('/api/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    prompt: promptText,
                    rotation: rotation,
                    images: uploadedImages
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Ein unbekannter Fehler ist aufgetreten.');
            }

            const data = await response.json();
            
            if (data && data.image) {
                generatedImage.src = `data:image/png;base64,${data.image}`;
                generatedImage.classList.remove('hidden');
                imageViewer.classList.remove('bg-gray-200');
                rotationButtons.classList.remove('hidden');
            } else {
                throw new Error("Fehler bei der API-Antwort: Es wurde kein Bild generiert.");
            }
        } catch (error) {
            console.error('Generierungsfehler:', error);
            showMessage(`Ein Fehler ist aufgetreten: ${error.message}`);
        } finally {
            generateBtn.disabled = false;
            generateBtn.innerHTML = 'Foto generieren';
            loadingIndicator.classList.add('hidden');
        }
    }

    // Initialer Klick-Handler für den Generierungsbutton
    generateBtn.addEventListener('click', () => {
        currentRotationAngle = 0;
        generateImage(currentRotationAngle);
    });

    // Klick-Handler für die Rotationsbuttons
    rotateLeftBtn.addEventListener('click', () => {
        currentRotationAngle -= rotationIncrement;
        if (currentRotationAngle < -rotationLimit) {
            currentRotationAngle = -rotationLimit;
        }
        generateImage(currentRotationAngle);
    });

    rotateRightBtn.addEventListener('click', () => {
        currentRotationAngle += rotationIncrement;
        if (currentRotationAngle > rotationLimit) {
            currentRotationAngle = rotationLimit;
        }
        generateImage(currentRotationAngle);
    });
});
</script>

</body>
</html>
